name: Build and Test - All Services

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/cybersensei

jobs:
  # ===========================================================================
  # Detect Changes
  # ===========================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      node-backend: ${{ steps.changes.outputs.node-backend }}
      node-dashboard: ${{ steps.changes.outputs.node-dashboard }}
      node-ai: ${{ steps.changes.outputs.node-ai }}
      central-backend: ${{ steps.changes.outputs.central-backend }}
      central-dashboard: ${{ steps.changes.outputs.central-dashboard }}
      teams-app: ${{ steps.changes.outputs.teams-app }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            node-backend:
              - 'cybersensei-node/backend/**'
              - '.github/workflows/build-and-test.yml'
            node-dashboard:
              - 'cybersensei-node/dashboard/**'
              - '.github/workflows/build-and-test.yml'
            node-ai:
              - 'cybersensei-node/ai/**'
              - '.github/workflows/build-and-test.yml'
            central-backend:
              - 'cybersensei-central/backend/**'
              - '.github/workflows/build-and-test.yml'
            central-dashboard:
              - 'cybersensei-central/dashboard/**'
              - '.github/workflows/build-and-test.yml'
            teams-app:
              - 'cybersensei-teams-app/**'
              - '.github/workflows/build-and-test.yml'

  # ===========================================================================
  # Node Backend (Spring Boot)
  # ===========================================================================
  node-backend:
    name: Node Backend
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.node-backend == 'true'
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: cybersensei_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Build with Maven
        working-directory: cybersensei-node/backend
        run: mvn clean package -DskipTests -B
      
      - name: Run Tests
        working-directory: cybersensei-node/backend
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/cybersensei_test
          SPRING_DATASOURCE_USERNAME: test
          SPRING_DATASOURCE_PASSWORD: test
        run: mvn test -B
      
      - name: Upload JAR
        uses: actions/upload-artifact@v4
        with:
          name: node-backend-jar
          path: cybersensei-node/backend/target/*.jar
          retention-days: 7

  # ===========================================================================
  # Node Dashboard (React)
  # ===========================================================================
  node-dashboard:
    name: Node Dashboard
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.node-dashboard == 'true'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: cybersensei-node/dashboard/package-lock.json
      
      - name: Install dependencies
        working-directory: cybersensei-node/dashboard
        run: npm ci
      
      - name: Lint
        working-directory: cybersensei-node/dashboard
        run: npm run lint || true
      
      - name: Build
        working-directory: cybersensei-node/dashboard
        run: npm run build
      
      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: node-dashboard-build
          path: cybersensei-node/dashboard/dist
          retention-days: 7

  # ===========================================================================
  # Central Backend (NestJS)
  # ===========================================================================
  central-backend:
    name: Central Backend
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.central-backend == 'true'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: cybersensei-central/backend/package-lock.json
      
      - name: Install dependencies
        working-directory: cybersensei-central/backend
        run: npm ci
      
      - name: Lint
        working-directory: cybersensei-central/backend
        run: npm run lint || true
      
      - name: Type check
        working-directory: cybersensei-central/backend
        run: npx tsc --noEmit || true
      
      - name: Build
        working-directory: cybersensei-central/backend
        run: npm run build
      
      - name: Run tests
        working-directory: cybersensei-central/backend
        run: npm test -- --passWithNoTests
      
      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: central-backend-build
          path: cybersensei-central/backend/dist
          retention-days: 7

  # ===========================================================================
  # Central Dashboard (React)
  # ===========================================================================
  central-dashboard:
    name: Central Dashboard
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.central-dashboard == 'true'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: cybersensei-central/dashboard/package-lock.json
      
      - name: Install dependencies
        working-directory: cybersensei-central/dashboard
        run: npm ci
      
      - name: Lint
        working-directory: cybersensei-central/dashboard
        run: npm run lint || true
      
      - name: Build
        working-directory: cybersensei-central/dashboard
        run: npm run build
      
      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: central-dashboard-build
          path: cybersensei-central/dashboard/dist
          retention-days: 7

  # ===========================================================================
  # Teams App
  # ===========================================================================
  teams-app:
    name: Teams App
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.teams-app == 'true'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: cybersensei-teams-app/tabs/employee/package-lock.json
      
      - name: Install dependencies
        working-directory: cybersensei-teams-app/tabs/employee
        run: npm ci
      
      - name: Lint
        working-directory: cybersensei-teams-app/tabs/employee
        run: npm run lint || true
      
      - name: Build
        working-directory: cybersensei-teams-app/tabs/employee
        run: npm run build
      
      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: teams-app-build
          path: cybersensei-teams-app/tabs/employee/dist
          retention-days: 7

  # ===========================================================================
  # Build Summary
  # ===========================================================================
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [node-backend, node-dashboard, central-backend, central-dashboard, teams-app]
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "## ðŸŽ‰ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Node Backend | ${{ needs.node-backend.result == 'success' && 'âœ…' || needs.node-backend.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Node Dashboard | ${{ needs.node-dashboard.result == 'success' && 'âœ…' || needs.node-dashboard.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Central Backend | ${{ needs.central-backend.result == 'success' && 'âœ…' || needs.central-backend.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Central Dashboard | ${{ needs.central-dashboard.result == 'success' && 'âœ…' || needs.central-dashboard.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Teams App | ${{ needs.teams-app.result == 'success' && 'âœ…' || needs.teams-app.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY


